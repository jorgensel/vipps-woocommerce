PICKUP POINT  => Pakke til hentested

TODO: ADD ORDER ID TO RETURN URL
        // IOK 2019-11-19 We have to do this because even though we actually store the order ID in the session, we can a) be redirected to another browser than the one with
        // the session, and b) some plugins wipe the session for guest purchases. So we might need to restore (enough of the) session to get to the than you page,
        // even if the session is gone or in another castle.

   $returnurl = add_query_arg('t',$authtoken,$returnurl);

Ellers brukes *tk* men
!wp_check_password($_REQUEST['tk'], $order->get_meta('_vipps_authtoken')))) 

så man kan sjekke denne mot ordreid.

^^^^^^ add the order id here. Check both. Remove transients.


// Betale eksisterende ordre ser *slik* ut:
https://vdev.digitalt.org/vipps_checkout/order-pay/3173/?pay_for_order=true&key=wc_order_a8qIMx4figarw

 $order_id = absint( get_query_var( 'order-pay' ) );


https://vdev.digitalt.org/handlekurv/?cancel_order=true&order=wc_order_a8qIMx4figarw&order_id=3173&redirect=https%3A%2F%2Fvdev.digitalt.org%2Fmin-konto%2F&_wpnonce=1218cd637c

så ha en hook på order-cancelled også plz

** lag en ordremeta som er *vipps session*
** foreløpig:

 WC()->session->get('vipps_checkout_current_pending')
     $order = $current_pending ? wc_get_order($current_pending) : null;

       $current_vipps_session = $order ? WC()->session->get('current_vipps_session') : false;
         // A single word or array containing session data, containing token and frontendFrameUrl
        // ERROR EXPIRED FAILED
        $session_status = $current_vipps_session ? $this->get_vipps_checkout_status($current_vipps_session) : null;

	   if (WC()->session) {
            WC()->session->set('vipps_checkout_current_pending',0);
            WC()->session->set('current_vipps_session', null);
            WC()->session->set('vipps_address_hash', false);


det er altås en current pending ordre, current session, og vipps address hash, samtidig

Alt kan pakkes inn i en verdi som er ordreobjektet. 

Vipps address hash var for å rekalkulere shipping tror, så det kan kanskje fjernes nå,
men åå hente adresseinfo er relevatn igjen for delendum


TODO HANDLE LOGIN AND USER CREATION BY USING


    [userInfo] => Array
        (
            [sub] => 0ea76f1a-7102-4947-b53f-9a7aff1ea5e9
            [email] => iver+test@wp-hosting.no
        )

- IF PRESENT - but check against actual order used? order->get_meta('vipps_email', 'vipps, sub')?


så jeg må lage en "ensureUserDetails"

TODO: Skift tittel på siden fra Vipps Checkout til <ikkenoe> elns
TODO: Skift tekst på "feilmelding fra vipps" til "melding i vipps"
TODO: Forbedre integrajsonen med vipps login plz
TODO: Hold session aktiv i Vipps checkout ved å endre addressen helt til den blir cancellet. Revive den ved retur.
DONE : Hør med vipps og edisoft
TODO: checkout direct:
https://github.com/vippsas/vipps-checkout-api/blob/main/vipps-checkout-api.md#vipps-checkout-direct


* PICKUP_POINT gir ekstra felt i shippingDetails med id + addressefelter
            [pickupPoint] => Array
                (
                    [id] => 128026
                    [name] => REMA 1000 Parkveien
                    [address] => PARKVEIEN 21
                    [postalCode] => 0352
                    [city] => OSLO
                    [country] => NO
                )
* HOME_DELIVERY gir
 <nugazi>

TODO: Legg til som order note også, og kjør hook på ordren

TODO: RENAME BRAND AND TYPE (ihverfall type!)

TODO: Hvis bestilling er cancelled når man kommer tilbake til butikken - sjekk 1 gang hos Vipps likevel, kanskje den er i orden

TODO: Porterbuddy krever 0 i pris - _dynamisk prising_ . IKKE FREE SHIPPING
** pris kommer per *epost*, pris hadde vært .  testnøkler?
DYNAMISK PRISING ER EN TING




https://vipps-checkout-dummymerchant-uat-app.azurewebsites.net/
