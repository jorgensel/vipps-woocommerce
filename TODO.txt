PICKUP POINT  => Pakke til hentested


// Betale eksisterende ordre ser *slik* ut:
https://vdev.digitalt.org/vipps_checkout/order-pay/3173/?pay_for_order=true&key=wc_order_a8qIMx4figarw

 $order_id = absint( get_query_var( 'order-pay' ) );


https://vdev.digitalt.org/handlekurv/?cancel_order=true&order=wc_order_a8qIMx4figarw&order_id=3173&redirect=https%3A%2F%2Fvdev.digitalt.org%2Fmin-konto%2F&_wpnonce=1218cd637c

så ha en hook på order-cancelled også plz

** lag en ordremeta som er *vipps session*
** foreløpig:

 WC()->session->get('vipps_checkout_current_pending')
     $order = $current_pending ? wc_get_order($current_pending) : null;

       $current_vipps_session = $order ? WC()->session->get('current_vipps_session') : false;
         // A single word or array containing session data, containing token and frontendFrameUrl
        // ERROR EXPIRED FAILED
        $session_status = $current_vipps_session ? $this->get_vipps_checkout_status($current_vipps_session) : null;

	   if (WC()->session) {
            WC()->session->set('vipps_checkout_current_pending',0);
            WC()->session->set('current_vipps_session', null);
            WC()->session->set('vipps_address_hash', false);


det er altås en current pending ordre, current session, og vipps address hash, samtidig

Alt kan pakkes inn i en verdi som er ordreobjektet. 

Vipps address hash var for å rekalkulere shipping tror, så det kan kanskje fjernes nå,
men åå hente adresseinfo er relevatn igjen for delendum


TODO HANDLE LOGIN AND USER CREATION BY USING


    [userInfo] => Array
        (
            [sub] => 0ea76f1a-7102-4947-b53f-9a7aff1ea5e9
            [email] => iver+test@wp-hosting.no
        )

- IF PRESENT - but check against actual order used? order->get_meta('vipps_email', 'vipps, sub')?


så jeg må lage en "ensureUserDetails"

TODO: Skift tittel på siden fra Vipps Checkout til <ikkenoe> elns
TODO: Skift tekst på "feilmelding fra vipps" til "melding i vipps"
TODO: Forbedre integrajsonen med vipps login plz
TODO: Hold session aktiv i Vipps checkout ved å endre addressen helt til den blir cancellet. Revive den ved retur.
DONE : Hør med vipps og edisoft
TODO: checkout direct:
https://github.com/vippsas/vipps-checkout-api/blob/main/vipps-checkout-api.md#vipps-checkout-direct


TODO: Legg til som order note også, og kjør hook på ordren ved pickup point/home delivery

TODO: RENAME BRAND AND TYPE (ihverfall type!)

TODO: Hvis bestilling er cancelled når man kommer tilbake til butikken - sjekk 1 gang hos Vipps likevel, kanskje den er i orden

TODO: Porterbuddy krever 0 i pris - _dynamisk prising_ . IKKE FREE SHIPPING
** pris kommer per *epost*, pris hadde vært .  testnøkler?
DYNAMISK PRISING ER EN TING
** må nå sjekke vippsamount og sammenligne med order-amount *før* prisen er satt.. og så sette pris på fraktmetode


TODO: Endre navn fra 'type' til noe annet

https://vipps-checkout-dummymerchant-uat-app.azurewebsites.net/

WC_Tax::get_shipping_tax_rates()
Shipping tax rates Array
(
    [1] => Array
        (
            [rate] => 25
            [label] => mva
            [shipping] => yes
            [compound] => no
        )

)


OG FOR BEREGNINGEN:
[26-Jan-2023 14:10:08 UTC] setting shipping details via poll
[26-Jan-2023 14:10:09 UTC] ordertotal 199.00 vippsamount 0

men også på callback (!)
[26-Jan-2023 14:13:08 UTC] setting shipping details via poll
[26-Jan-2023 14:13:08 UTC] ordertotal 199.00 vippsamount 0

ah men også
[26-Jan-2023 14:31:18 UTC] Setting shipping details via callback
[26-Jan-2023 14:31:18 UTC] ordertotal 199.00 vippsamount 0

ok så callback da, checkout:
[26-Jan-2023 14:36:07 UTC] Setting shipping details via callback
[26-Jan-2023 14:36:07 UTC] ordertotal 199.00 vippsamount 0
[26-Jan-2023 14:36:07 UTC] vipsamount 23900 trnasaction Array
(
    [transactionId] => checkout_woodigitalt3238
    [timeStamp] => 2023-01-26 14:36:07
    [amount] => 23900
    [currency] => NOK
    [status] => AUTHORIZED
)
og express:
[26-Jan-2023 14:37:15 UTC] Setting shipping details via callback
[26-Jan-2023 14:37:15 UTC] ordertotal 1.00 vippsamount 0
[26-Jan-2023 14:37:15 UTC] vipsamount 100 trnasaction Array
(
    [amount] => 100
    [status] => RESERVE
    [timeStamp] => 2023-01-26T14:37:03.223Z
    [transactionId] => 5003259633
    [currency] => NOK
)

TODO: SJEKK AT POLL RETURNERER userinfo! Foreløpig bare i callback? v2 vs v3?
