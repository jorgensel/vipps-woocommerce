TODO Gjør RequireUserInfo til valgrfitt?

OG fjern _vipps_pending_order  - den gjør ikke noe verdifullt mer.


// Betale eksisterende ordre ser *slik* ut:
https://vdev.digitalt.org/vipps_checkout/order-pay/3173/?pay_for_order=true&key=wc_order_a8qIMx4figarw
 $order_id = absint( get_query_var( 'order-pay' ) );
https://vdev.digitalt.org/handlekurv/?cancel_order=true&order=wc_order_a8qIMx4figarw&order_id=3173&redirect=https%3A%2F%2Fvdev.digitalt.org%2Fmin-konto%2F&_wpnonce=1218cd637c

så ha en hook på order-cancelled også plz

** lag en ordremeta som er *vipps session*
** foreløpig:

 WC()->session->get('vipps_checkout_current_pending')
     $order = $current_pending ? wc_get_order($current_pending) : null;

       $current_vipps_session = $order ? WC()->session->get('current_vipps_session') : false;
         // A single word or array containing session data, containing token and frontendFrameUrl
        // ERROR EXPIRED FAILED
        $session_status = $current_vipps_session ? $this->get_vipps_checkout_status($current_vipps_session) : null;

	   if (WC()->session) {
            WC()->session->set('vipps_checkout_current_pending',0);
            WC()->session->set('current_vipps_session', null);
            WC()->session->set('vipps_address_hash', false);


det er altås en current pending ordre, current session, og vipps address hash, samtidig

Alt kan pakkes inn i en verdi som er ordreobjektet. 

Vipps address hash var for å rekalkulere shipping tror, så det kan kanskje fjernes nå,
men åå hente adresseinfo er relevatn igjen for delendum


TODO HANDLE LOGIN AND USER CREATION BY USING


    [userInfo] => Array
        (
            [sub] => 0ea76f1a-7102-4947-b53f-9a7aff1ea5e9
            [email] => iver+test@wp-hosting.no
        )

- IF PRESENT - but check against actual order used? order->get_meta('vipps_email', 'vipps, sub')?


så jeg må lage en "ensureUserDetails"

TODO: Forbedre integrajsonen med vipps login plz
TODO: Hold session aktiv i Vipps checkout ved å endre addressen helt til den blir cancellet. Revive den ved retur.

TODO: checkout direct:
https://github.com/vippsas/vipps-checkout-api/blob/main/vipps-checkout-api.md#vipps-checkout-direct

TODO: Hvis bestilling er cancelled når man kommer tilbake til butikken - sjekk 1 gang hos Vipps likevel, kanskje den er i orden


/kunder/wp/m/moo/wp-utvikling/wp-content/plugins/mailchimp-for-wp (populær)
               // specific hooks for klarna
            add_filter( 'kco_create_order', array( $this, 'add_klarna_field' ) );
            add_filter( 'klarna_after_kco_confirmation', array( $this, 'subscribe_from_klarna_checkout' ), 10, 2 );
   class-woocommerce.php:			add_action( 'woocommerce_checkout_update_order_meta', array( $this, 'save_woocommerce_checkout_checkbox_value' ) );
class-woocommerce.php:		add_action( 'woocommerce_checkout_order_processed', array( $this, 'subscribe_from_woocommerce_checkout' ) );
   $do_optin = get_post_meta( $order_id, '_mc4wp_optin', true );


/kunder/wp/d/designbelysning/wp-utvikling/wp-content/plugins/mailchimp-for-woocommerce (offisiell)
https://wordpress.org/plugins/woocommerce-mailchimp/ ("premium"?)

includes/class-mailchimp-woocommerce.php:                       $this->loader->add_action('woocommerce_checkout_order_processed', $service, 'processNewsletterField', 10, 2);



*TODO FIKS BEDRE HPNDTERING AV FAKEPAGE
** det som går an her er å modifisere the content og the filter til å kjøre de funksjonene vi vil generere
** ELLER å simpelthen returnere en shortcode
add_filter('pre_handle_404', function ($current, $query) {
    if (!is_admin() && class_exists('Vipps')) {
        $special = Vipps::instance()->is_special_page();
        if ($special) {
          add_filter('the_content', function ($foo)  {
            return "<h1>YOLO</h1>$foo";
          });
          add_filter('the_title', function ($bar) {
            return "foobar $bar";
        });
          add_filter('document_title_parts', function ($parts) {
              $parts['title'] = "foobar {$parts['title']}";
              return $parts;
          });
          return true; // We'll handle this thank you
        }
    }
    return $current;
}, 1, 2);

